<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>WI-FI Provision Via BLE - Quick-DEV Programming Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "WI-FI Provision Via BLE";
        var mkdocs_page_input_path = "application-guide\\wifi_provision_via_ble.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Quick-DEV Programming Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Quick-DEV FWK</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../get_started/get_started/">Get Started</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Application Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../project_config/">Project Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../log_config/">Log Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wifi/">WI-Fi</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ble/">BluetoothLE</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">WI-FI Provision Via BLE</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#provision-process">Provision Process</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#opl-service">OPL Service</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#initialize">Initialize</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initialize-the-opl-service-in-your-application">Initialize the OPL service in your application</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#generate-a-data-passthrough">Generate a data passthrough</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to">How to...</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-create-an-user-defined-service-eg-quick_devapp_refble_data_protopl_svcc-in-ble-manager">How to create an user defined service (e.g. quick_dev\app_ref\ble_data_prot\opl_svc.c) in BLE Manager</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-receive-ble-data-in-and-then-export-to-ble-application-in-application">How to receive BLE data in and then export to BLE Application in application</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-handle-wi-fi-provision-message-via-ble-in-ble-application">How to handle Wi-Fi provision message via BLE in BLE Application</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-respnose-wi-fi-process-result-to-phone">How to respnose Wi-Fi process result to phone</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cloud/">Cloud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ota/">OTA</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/ble_example/">BLE</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/cloud_example/">Cloud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/qd_app_example/">Start Up</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/wifi_example/">WI-FI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/host_mode_example/">Host_Mode</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-reference/wifi_apis/">WI-FI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-reference/ble_apis/">BluetoothLE</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-reference/cloud_apis/">Cloud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-reference/ota_apis/">OTA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-reference/opl_error_code/">OPL Error Code</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Quick-DEV Programming Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Application Guide &raquo;</li>
      <li>WI-FI Provision Via BLE</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Opulinks-Tech/QuickDev-Framework/edit/master/docs/application-guide/wifi_provision_via_ble.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="wi-fi-provision-via-ble">WI-FI provision via BLE</h1>
<p>The advantage of dual-core chip (OPL series), QuickDev-Framework provide a process to provision Wi-Fi credentials of the Home AP via the Bluetooth low energy (BLE). This setion can help the developer to quickly understand and implement the protocol into the application.</p>
<p align="center"><img src="/application-guide/img/wifi_prv_via_ble.png"></p>

<p>This block diagram introduces the architecture of the provision Wi-Fi credentials via BLE. The phone (BLE central) will transmitting the required message to the device. When the device received the message, it will process the Wi-Fi connection base on the given information.</p>
<p>Opulinks also provide a reference code-base for Phone APP, the front-end developer can use the needed code-base to enhance on their project/product.</p>
<ul>
<li>Android APP : </li>
<li>IOS APP : </li>
<li>WeChat mini APP : </li>
</ul>
<h3 id="provision-process">Provision Process</h3>
<p>QuickDev-Framework had provided the Wi-Fi provision via BLE protocol, for a quick look to the example which can demonstrate the Wi-Fi provision via BLE protocol, please check on <a href="../../examples/qd_app_example/">QD_APP</a> section.</p>
<p>In below diagram, it present a simplify steps that how's the provision done.</p>
<p align="center"><img src="/application-guide/img/wifi_prv_flow_chart.png"></p>

<p>When the phone (BLE central) wants to provision the Wi-Fi credential and connect to AP, the phone (BLE central) will send the command and required message to the device, e.g. Wi-Fi scan request or Wi-Fi connect request.</p>
<p>And the device is responsible to receive and parsing the required message, then progress the Network manager to processing according to different events.</p>
<p>While Network manager had done with indicate or unsolicited callback returns, then the device will transit the corresponding response or result to the the phone (BLE central) for notify the status.</p>
<p>The focusing of provision process is to create a BLE data command list to letting the phone (BLE central) and the device can recognize the data and handling in such.</p>
<h3 id="opl-service">OPL Service</h3>
<p>OPL service is one of the profile service collection in BLE which designed by Opulinks that including the Wi-Fi provision command &amp; handler needed.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>To understand the BLE manager and BLE service can refer to <a href="../ble/">BluetoothLE</a></p>
</div>
<p>The OPL service UUID defined in <code>quick_dev/app_ref/ble_data_prot/opl_data/opl_svc.h</code></p>
<table>
<thead>
<tr>
<th align="left">Service/Characteristic</th>
<th align="left">UUID</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">OPL service</td>
<td align="left">0xAAAA</td>
</tr>
<tr>
<td align="left">DATA IN character</td>
<td align="left">0xBBB0</td>
</tr>
<tr>
<td align="left">DATA OUT character</td>
<td align="left">0xBBB1</td>
</tr>
</tbody>
</table>
<h3 id="initialize">Initialize</h3>
<p>To using this service on your application, please follow in below items.</p>
<h6 id="initialize-the-opl-service-in-your-application">Initialize the OPL service in your application</h6>
<p>Add <code>OPL_Svc_Init()</code> in <code>app_main.c</code></p>
<pre><code class="language-c">void APP_BleInit(void)
{
    // assign unsolicited callback function
    Opl_Ble_Uslctd_CB_Reg(&amp;APP_BleUnsolicitedCallback);

    // register service
    GAP_Svc_Init();
    GATT_Svc_Init();

    // register opl service
    OPL_Svc_Init();  // &lt;- initialize OPL service

    // initialize the ble manager (auto-adv)
    Opl_Ble_Init_Req(true);

    // user implement
}
</code></pre>
<h6 id="generate-a-data-passthrough">Generate a data passthrough</h6>
<p>When the data received, the <code>OPL_SVC_DATA_IN</code> characteristic contents in OPL service will execute a context switch to passing the received data from BLE manager to host application, so we need to create a catcher on application side, and let it process the data parsing and progress.</p>
<p align="center"><img src="/application-guide/img/ble_svc_data_pass_block.png"></p>

<p>Add the <code>APP_EVT_BLE_DATA_IND</code> event and handler in <code>app_main.c</code>.</p>
<pre><code class="language-c">static T_AppEvtHandlerTbl g_tAppEvtHandlerTbl[] = 
{
    ...

    {APP_EVT_BLE_DATA_IND,                  APP_EvtHandler_BleDataInd},

    ...

    {0xFFFFFFFF,                            NULL},
};
</code></pre>
<p>Then add <code>OPL_DataRecvHandler()</code> to let the handler do parsing and progress.</p>
<pre><code class="language-c">static void APP_EvtHandler_BleDataInd(uint32_t u32EventId, void *pData, uint32_t u32DataLen)
{
    OPL_DataRecvHandler(pData, (uint16_t)u32DataLen);
}
</code></pre>
<p>At final steps, we must enable the protocol definition in `qd_module.h"</p>
<pre><code class="language-c">//==========================================================
// &lt;h&gt; OPL Data protocol
//==========================================================

// &lt;e&gt; OPL_DATA_ENABLED - Opulinks BLE WI-FI data protocol
//==========================================================
#ifndef OPL_DATA_ENABLED
#define OPL_DATA_ENABLED                        (1)
#endif
</code></pre>
<p>And that's the wrap, the Wi-Fi provision via BLE function has been activated in your application. It's recommend to using our standard phone APP by searching "Opulinks Wireless Utilities" at APP store to try with.</p>
<h2 id="how-to">How to...</h2>
<h3 id="how-to-create-an-user-defined-service-eg-quick_devapp_refble_data_protopl_svcc-in-ble-manager">How to create an user defined service (e.g. <code>quick_dev\app_ref\ble_data_prot\opl_svc.c</code>) in BLE Manager</h3>
<p>Please refer to <a href="../ble/">BluetoothLE</a></p>
<h3 id="how-to-receive-ble-data-in-and-then-export-to-ble-application-in-application">How to receive BLE data in and then export to BLE Application in application</h3>
<ul>
<li><strong>Create a gatt dispatch handler (e.g. <code>OPL_Svc_GattDispatchHandler()</code>) in user defined service</strong> </li>
</ul>
<pre><code class="language-c">static T_OplErr OPL_Svc_GattDispatchHandler(MESSAGEID tId, MESSAGE tMsg)
{
    switch(tId)
    {
        case LE_GATT_MSG_ACCESS_READ_IND:
        {
            OPL_Svc_GattDispatchReadHandler((LE_GATT_MSG_ACCESS_READ_IND_T *)tMsg);
            break;
        }

        case LE_GATT_MSG_ACCESS_WRITE_IND:
        {
            OPL_Svc_GattDispatchWriteHandler((LE_GATT_MSG_ACCESS_WRITE_IND_T *)tMsg);
            break;
        }

        case LE_GATT_MSG_NOTIFY_CFM:
        {
            Opl_Ble_Send_Message(OPL_SVC_EVT_SEND_TO_PEER_CFM, NULL, 0, 0);
            break;
        }

        default:
        {
            return OPL_ERR_CASE_INVALID;
        }
    }

    return OPL_OK;
}
</code></pre>
<p>This example is receiving <code>LE_GATT_MSG_ACCESS_WRITE_IND</code> event to handle BLE data via <code>OPL_Svc_GattDispatchWriteHandler()</code></p>
<pre><code class="language-c">tatic void OPL_Svc_GattDispatchWriteHandler(LE_GATT_MSG_ACCESS_WRITE_IND_T *ind)
{
    // process the write access activity in each characteristic
    uint8_t u8AttErr = 0;
    uint16_t u16AttrId = ind-&gt;handle - g_tOplSvcHandle.ptSvcDef-&gt;startHdl;

    switch(u16AttrId)
    {
        case OPL_SVC_IDX_DATA_IN_VAL:
        {
            APP_SendMessage(APP_EVT_BLE_DATA_IND, ind-&gt;pVal, ind-&gt;len);

            break;
        }

        case OPL_SVC_IDX_DATA_OUT_CFG:
        {
            uint16_t u16Enable = *((uint16_t *)ind-&gt;pVal);

            if ((ind-&gt;len == 2) &amp;&amp; (u16Enable &lt;= 1))
            {
                LeGattChangeAttrVal(g_tOplSvcHandle.ptSvcDef, OPL_SVC_IDX_DATA_OUT_CFG, sizeof(u16Enable), &amp;u16Enable);
            }
            else
            {
                u8AttErr = LE_ATT_ERR_INVALID_ATTR_VALUE_LEN;
            }

            break;
        }

        default:
        {
            u8AttErr = LE_ATT_ERR_WRITE_NOT_PERMITTED;
            break;
        }
    }
</code></pre>
<p>If receiving <code>OPL_SVC_IDX_DATA_IN_VAL</code>, <code>OPL_Svc_GattDispatchWriteHandler()</code> could send BLE data to application via <code>APP_SendMessage()</code></p>
<p>In application, developer could create a function (e.g. <code>APP_EvtHandler_BleDataInd()</code>) to send BLE data to BLE Application.</p>
<pre><code class="language-c">static void APP_EvtHandler_BleDataInd(uint32_t u32EventId, void *pData, uint32_t u32DataLen)
{
    OPL_DataRecvHandler(pData, (uint16_t)u32DataLen);
}
</code></pre>
<h3 id="how-to-handle-wi-fi-provision-message-via-ble-in-ble-application">How to handle Wi-Fi provision message via BLE in BLE Application</h3>
<p>BLE Application is responsible for parsing the messages from BLE, and then processing these events by category. Wi-Fi provision messages include Wi-Fi scan, Wi-Fi connect, Wi-Fi disconnect, Wi-Fi reconnect, read device Wi-Fi information, write Wi-Fi device information, get device Wi-Fi status and reset Wi-Fi. It is a BLE Application event handler table <code>g_tOplDataEventHandlerTbl</code> to handle these events. </p>
<pre><code class="language-c">static T_OplDataEventTable g_tOplDataEventHandlerTbl[] =
{
    {OPL_DATA_REQ_SCAN,                      OPL_DataProtocol_Scan},
    {OPL_DATA_REQ_CONNECT,                   OPL_DataProtocol_Connect},
    {OPL_DATA_REQ_DISCONNECT,                OPL_DataProtocol_Disconnect},
    {OPL_DATA_REQ_RECONNECT,                 OPL_DataProtocol_Reconnect},
    {OPL_DATA_REQ_READ_DEVICE_INFO,          OPL_DataProtocol_ReadDeviceInfo},
    {OPL_DATA_REQ_WRITE_DEVICE_INFO,         OPL_DataProtocol_WriteDeviceInfo},
    {OPL_DATA_REQ_WIFI_STATUS,               OPL_DataProtocol_WifiStatus},
    {OPL_DATA_REQ_RESET,                     OPL_DataProtocol_Reset},
</code></pre>
<p>For example, if receiving <code>OPL_DATA_REQ_SCAN</code>, <code>OPL_DataProtocol_Scan</code> handler will send Wi-Fi scan message to Network Manager to execute Wi-Fi scan.</p>
<pre><code class="language-c">static void OPL_DataProtocol_Scan(uint16_t type, uint8_t *data, int len)
{
    OPL_LOG_DEBG(OPL, &quot;OPL_DATA_REQ_SCAN&quot;);

    // reset connection config table
    memset(&amp;g_tOplDataConnCfg, 0, sizeof(T_OplDataConnCfg));

    g_tOplDataConnCfg.u8ConnectType = OPL_DATA_CONN_TYPE_BSSID;

    // trigger scan request
    APP_NmWifiScanReq(OPL_DataHandler_WifiScanDoneIndCb);
}
</code></pre>
<h3 id="how-to-respnose-wi-fi-process-result-to-phone">How to respnose Wi-Fi process result to phone</h3>
<p>BLE Application send Wi-Fi provision message to Network Manager, and then Network Manager will create a callback function to handle indicate callback.</p>
<p>For example, if Wi-Fi scan done, the Wi-FI scan done callback <code>OPL_DataHandler_WifiScanDoneIndCb</code> will follow up on scan done.</p>
<pre><code class="language-c">void OPL_DataHandler_WifiScanDoneIndCb(T_OplErr tEvtRst)
{
    OPL_LOG_DEBG(OPL, &quot;Wifi scan done ind %d&quot;, tEvtRst);

    if(OPL_DATA_CONN_TYPE_BSSID == g_tOplDataConnCfg.u8ConnectType)
    {
        // CK_DATA_REQ_SCAN cmd, just do report scan list
        _OPL_DataHandler_SendScanReport();
        OPL_DataSendResponse(OPL_DATA_RSP_SCAN_END, 0);
    }
}
</code></pre>
<p><code>_OPL_DataHandler_SendScanReport</code> will obtain the information of APs via Wi-Fi Manager in the environment, and sort out the AP list. </p>
<pre><code class="language-c">static int _OPL_DataHandler_SendScanReport(void)
{
    wifi_scan_info_t *pstAPList = NULL;
    wifi_auto_connect_info_t *info = NULL;
    T_WmScanInfo *pstWifiAPList = NULL;

    uint8_t u8APPAutoConnectGetApNum = 0;
    // uint8_t u8IsUpdate = false;
    uint16_t u16apCount = 0;

    int32_t i = 0, j = 0;

    // TODO: get ap number
    Opl_Wifi_ApNum_Get(&amp;u16apCount);

    OPL_LOG_INFO(OPL, &quot;AP num = %d&quot;, u16apCount);

    pstAPList = (wifi_scan_info_t *)malloc(sizeof(wifi_scan_info_t) * u16apCount);

    // TODO: get ap record
    Opl_Wifi_ApRecord_Get(&amp;u16apCount, pstAPList);

    pstWifiAPList = (T_WmScanInfo *)malloc(sizeof(T_WmScanInfo) * u16apCount);

    memset(pstWifiAPList , 0 , sizeof(T_WmScanInfo) * u16apCount);

    // TODO: get auto connect ap number
    Opl_Wifi_AutoConnectApNum_Get(&amp;u8APPAutoConnectGetApNum);

    if (u8APPAutoConnectGetApNum)
    {
        info = (wifi_auto_connect_info_t *)malloc(sizeof(wifi_auto_connect_info_t) * u8APPAutoConnectGetApNum);

        memset(info, 0, sizeof(wifi_auto_connect_info_t) * u8APPAutoConnectGetApNum);

        for (i = 0; i &lt; u8APPAutoConnectGetApNum; i++)
        {

            // TODO: get auto connected ap info
            Opl_Wifi_AutoConnectApInfo_Get(i, info + i);
    }

    /* build blewifi ap list */
    for (i = 0; i &lt; u16apCount; ++i)
    {
        memcpy(pstWifiAPList[i].ssid, pstAPList[i].ssid, sizeof(pstAPList[i].ssid));
        memcpy(pstWifiAPList[i].bssid, pstAPList[i].bssid, WIFI_MAC_ADDRESS_LENGTH);
        pstWifiAPList[i].rssi = pstAPList[i].rssi;
        pstWifiAPList[i].auth_mode = pstAPList[i].auth_mode;
        pstWifiAPList[i].ssid_length = strlen((const char *)pstAPList[i].ssid);
        pstWifiAPList[i].connected = 0;
#if (1 == FLITER_STRONG_AP_EN)
        pstWifiAPList[i].u8IgnoreReport = false;
#endif
        for (j = 0; j &lt; u8APPAutoConnectGetApNum; j++)
        {
            if ((info+j)-&gt;ap_channel)
            {
                if(!memcmp(pstWifiAPList[i].ssid, (info+j)-&gt;ssid, sizeof((info+j)-&gt;ssid)) &amp;&amp; !memcmp(pstWifiAPList[i].bssid, (info+j)-&gt;bssid, sizeof((info+j)-&gt;bssid)))
                {
                    pstWifiAPList[i].connected = 1;
                    break;
                }
            }
        }
    }

    /* Send Data to BLE */
    /* Send AP inforamtion individually */
    for (i = 0; i &lt; u16apCount; ++i)
    {
#if (1 == FLITER_STRONG_AP_EN)
        if(true == pstWifiAPList[i].u8IgnoreReport)
        {
            continue;
        }
#endif
        if(pstWifiAPList[i].ssid_length != 0)
        {
            _OPL_DataHandler_SendSignalScanReport(1, &amp;pstWifiAPList[i]);
            osDelay(100);
        }
    }

    if (pstAPList)
        free(pstAPList);

    if (pstWifiAPList)
        free(pstWifiAPList);

    if (info)
        free(info);

    return ubAppErr;
}
</code></pre>
<p><code>_OPL_DataHandler_SendSignalScanReport</code> will organize the AP list</p>
<pre><code class="language-c">static void _OPL_DataHandler_SendSignalScanReport(uint16_t apCount, T_WmScanInfo *ap_list)
{
    uint8_t *data;
    int data_len;
    uint8_t *pos;
    int malloc_size = sizeof(T_WmScanInfo) * apCount;

    pos = data = malloc(malloc_size);
    if (data == NULL)
    {
        OPL_LOG_ERRO(OPL, &quot;malloc fail&quot;);
        return;
    }

    for (int i = 0; i &lt; apCount; ++i)
    {
        uint8_t len = ap_list[i].ssid_length;

        data_len = (pos - data);

        *pos++ = len;
        memcpy(pos, ap_list[i].ssid, len);
        pos += len;
        memcpy(pos, ap_list[i].bssid,6);
        pos += 6;
        *pos++ = ap_list[i].auth_mode;
        *pos++ = ap_list[i].rssi;
#ifdef CK_DATA_USE_CONNECTED
        *pos++ = ap_list[i].connected;
#else
        *pos++ = 0;
#endif
    }

    data_len = (pos - data);

    /* create scan report data packet */
    OPL_DataSendEncap(OPL_DATA_RSP_SCAN_REPORT, data, data_len);

    free(data);
}
</code></pre>
<p><code>OPL_DataSendEncap</code> is responsible for packing data in accordance with BLE packet format.</p>
<pre><code class="language-c">void OPL_DataSendEncap(uint16_t u16Type, uint8_t *pu8Data, uint32_t u32TotalDataLen)
{
    T_OplDataHdrTag *tHdrTag = NULL;
    int remain_len = u32TotalDataLen;

    /* 1.fragment data packet to fit MTU size */

    /* 2.Pack blewifi header */
    tHdrTag = malloc(sizeof(T_OplDataHdrTag) + remain_len);
    if (tHdrTag == NULL)
    {
        OPL_LOG_ERRO(OPL, &quot;malloc fail&quot;);
        return;
    }

    tHdrTag-&gt;u16EventId = u16Type;
    tHdrTag-&gt;u16DataLen = remain_len;
    if (tHdrTag-&gt;u16DataLen)
        memcpy(tHdrTag-&gt;au8Data, pu8Data, tHdrTag-&gt;u16DataLen);

    /* 3.send app data to BLE stack */

    Opl_Ble_Send_Message(OPL_SVC_EVT_SEND_DATA, (uint8_t *)tHdrTag, (tHdrTag-&gt;u16DataLen + sizeof(T_OplDataHdrTag)), 0);

    free(tHdrTag);
}
</code></pre>
<p><code>Opl_Ble_Send_Message</code> is responsible for sending scan done result (e.g. AP list) to phone via BLE Manager.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ble/" class="btn btn-neutral float-left" title="BluetoothLE"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cloud/" class="btn btn-neutral float-right" title="Cloud">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright 2022, Opulinks cooperation</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Opulinks-Tech/QuickDev-Framework" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../ble/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cloud/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
